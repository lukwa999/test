"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BinMsg = exports.Msg = exports.Response = exports.Query = void 0;
const BSON = require("../bson");
const error_1 = require("../error");
const read_preference_1 = require("../read_preference");
const utils_1 = require("../utils");
const constants_1 = require("./wire_protocol/constants");
// Incrementing request id
let _requestId = 0;
// Query flags
const OPTS_TAILABLE_CURSOR = 2;
const OPTS_SECONDARY = 4;
const OPTS_OPLOG_REPLAY = 8;
const OPTS_NO_CURSOR_TIMEOUT = 16;
const OPTS_AWAIT_DATA = 32;
const OPTS_EXHAUST = 64;
const OPTS_PARTIAL = 128;
// Response flags
const CURSOR_NOT_FOUND = 1;
const QUERY_FAILURE = 2;
const SHARD_CONFIG_STALE = 4;
const AWAIT_CAPABLE = 8;
/**************************************************************
 * QUERY
 **************************************************************/
/** @internal */
class Query {
    constructor(ns, query, options) {
        // Basic options needed to be passed in
        // TODO(NODE-3483): Replace with MongoCommandError
        if (ns == null)
            throw new error_1.MongoRuntimeError('Namespace must be specified for query');
        // TODO(NODE-3483): Replace with MongoCommandError
        if (query == null)
            throw new error_1.MongoRuntimeError('A query document must be specified for query');
        // Validate that we are not passing 0x00 in the collection name
        if (ns.indexOf('\x00') !== -1) {
            // TODO(NODE-3483): Use MongoNamespace static method
            throw new error_1.MongoRuntimeError('Namespace cannot contain a null character');
        }
        // Basic options
        this.ns = ns;
        this.query = query;
        // Additional options
        this.numberToSkip = options.numberToSkip || 0;
        this.numberToReturn = options.numberToReturn || 0;
        this.returnFieldSelector = options.returnFieldSelector || undefined;
        this.requestId = Query.getRequestId();
        // special case for pre-3.2 find commands, delete ASAP
        this.pre32Limit = options.pre32Limit;
        // Serialization option
        this.serializeFunctions =
            typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;
        this.ignoreUndefined =
            typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : false;
        this.maxBsonSize = options.maxBsonSize || 1024 * 1024 * 16;
        this.checkKeys = typeof options.checkKeys === 'boolean' ? options.checkKeys : false;
        this.batchSize = this.numberToReturn;
        // Flags
        this.tailable = false;
        this.secondaryOk = typeof options.secondaryOk === 'boolean' ? options.secondaryOk : false;
        this.oplogReplay = false;
        this.noCursorTimeout = false;
        this.awaitData = false;
        this.exhaust = false;
        this.partial = false;
    }
    /** Assign next request Id. */
    incRequestId() {
        this.requestId = _requestId++;
    }
    /** Peek next request Id. */
    nextRequestId() {
        return _requestId + 1;
    }
    /** Increment then return next request Id. */
    static getRequestId() {
        return ++_requestId;
    }
    // Uses a single allocated buffer for the process, avoiding multiple memory allocations
    toBin() {
        const buffers = [];
        let projection = null;
        // Set up the flags
        let flags = 0;
        if (this.tailable) {
            flags |= OPTS_TAILABLE_CURSOR;
        }
        if (this.secondaryOk) {
            flags |= OPTS_SECONDARY;
        }
        if (this.oplogReplay) {
            flags |= OPTS_OPLOG_REPLAY;
        }
        if (this.noCursorTimeout) {
            flags |= OPTS_NO_CURSOR_TIMEOUT;
        }
        if (this.awaitData) {
            flags |= OPTS_AWAIT_DATA;
        }
        if (this.exhaust) {
            flags |= OPTS_EXHAUST;
        }
        if (this.partial) {
            flags |= OPTS_PARTIAL;
        }
        // If batchSize is different to this.numberToReturn
        if (this.batchSize !== this.numberToReturn)
            this.numberToReturn = this.batchSize;
        // Allocate write protocol header buffer
        const header = Buffer.alloc(4 * 4 + // Header
            4 + // Flags
            Buffer.byteLength(this.ns) +
            1 + // namespace
            4 + // numberToSkip
            4 // numberToReturn
        );
        // Add header to buffers
        buffers.push(header);
        // Serialize the query
        const query = BSON.serialize(this.query, {
            checkKeys: this.checkKeys,
            serializeFunctions: this.serializeFunctions,
            ignoreUndefined: this.ignoreUndefined
        });
        // Add query document
        buffers.push(query);
        if (this.returnFieldSelector && Object.keys(this.returnFieldSelector).length > 0) {
            // Serialize the projection document
            projection = BSON.serialize(this.returnFieldSelector, {
                checkKeys: this.checkKeys,
                serializeFunctions: this.serializeFunctions,
                ignoreUndefined: this.ignoreUndefined
            });
            // Add projection document
            buffers.push(projection);
        }
        // Total message size
        const totalLength = header.length + query.length + (projection ? projection.length : 0);
        // Set up the index
        let index = 4;
        // Write total document length
        header[3] = (totalLength >> 24) & 0xff;
        header[2] = (totalLength >> 16) & 0xff;
        header[1] = (totalLength >> 8) & 0xff;
        header[0] = totalLength & 0xff;
        // Write header information requestId
        header[index + 3] = (this.requestId >> 24) & 0xff;
        header[index + 2] = (this.requestId >> 16) & 0xff;
        header[index + 1] = (this.requestId >> 8) & 0xff;
        header[index] = this.requestId & 0xff;
        index = index + 4;
        // Write header information responseTo
        header[index + 3] = (0 >> 24) & 0xff;
        header[index + 2] = (0 >> 16) & 0xff;
        header[index + 1] = (0 >> 8) & 0xff;
        header[index] = 0 & 0xff;
        index = index + 4;
        // Write header information OP_QUERY
        header[index + 3] = (constants_1.OP_QUERY >> 24) & 0xff;
        header[index + 2] = (constants_1.OP_QUERY >> 16) & 0xff;
        header[index + 1] = (constants_1.OP_QUERY >> 8) & 0xff;
        header[index] = constants_1.OP_QUERY & 0xff;
        index = index + 4;
        // Write header information flags
        header[index + 3] = (flags >> 24) & 0xff;
        header[index + 2] = (flags >> 16) & 0xff;
        header[index + 1] = (flags >> 8) & 0xff;
        header[index] = flags & 0xff;
        index = index + 4;
        // Write collection name
        index = index + header.write(this.ns, index, 'utf8') + 1;
        header[index - 1] = 0;
        // Write header information flags numberToSkip
        header[index + 3] = (this.numberToSkip >> 24) & 0xff;
        header[index + 2] = (this.numberToSkip >> 16) & 0xff;
        header[index + 1] = (this.numberToSkip >> 8) & 0xff;
        header[index] = this.numberToSkip & 0xff;
        index = index + 4;
        // Write header information flags numberToReturn
        header[index + 3] = (this.numberToReturn >> 24) & 0xff;
        header[index + 2] = (this.numberToReturn >> 16) & 0xff;
        header[index + 1] = (this.numberToReturn >> 8) & 0xff;
        header[index] = this.numberToReturn & 0xff;
        index = index + 4;
        // Return the buffers
        return buffers;
    }
}
exports.Query = Query;
/** @internal */
class Response {
    constructor(message, msgHeader, msgBody, opts) {
        this.documents = new Array(0);
        this.parsed = false;
        this.raw = message;
        this.data = msgBody;
        this.opts = opts !== null && opts !== void 0 ? opts : {
            promoteLongs: true,
            promoteValues: true,
            promoteBuffers: false,
            bsonRegExp: false
        };
        // Read the message header
        this.length = msgHeader.length;
        this.requestId = msgHeader.requestId;
        this.responseTo = msgHeader.responseTo;
        this.opCode = msgHeader.opCode;
        this.fromCompressed = msgHeader.fromCompressed;
        // Flag values
        this.promoteLongs = typeof this.opts.promoteLongs === 'boolean' ? this.opts.promoteLongs : true;
        this.promoteValues =
            typeof this.opts.promoteValues === 'boolean' ? this.opts.promoteValues : true;
        this.promoteBuffers =
            typeof this.opts.promoteBuffers === 'boolean' ? this.opts.promoteBuffers : false;
        this.bsonRegExp = typeof this.opts.bsonRegExp === 'boolean' ? this.opts.bsonRegExp : false;
    }
    isParsed() {
        return this.parsed;
    }
    parse(options) {
        var _a, _b, _c, _d;
        // Don't parse again if not needed
        if (this.parsed)
            return;
        options = options !== null && options !== void 0 ? options : {};
        // Allow the return of raw documents instead of parsing
        const raw = options.raw || false;
        const documentsReturnedIn = options.documentsReturnedIn || null;
        const promoteLongs = (_a = options.promoteLongs) !== null && _a !== void 0 ? _a : this.opts.promoteLongs;
        const promoteValues = (_b = options.promoteValues) !== null && _b !== void 0 ? _b : this.opts.promoteValues;
        const promoteBuffers = (_c = options.promoteBuffers) !== null && _c !== void 0 ? _c : this.opts.promoteBuffers;
        const bsonRegExp = (_d = options.bsonRegExp) !== null && _d !== void 0 ? _d : this.opts.bsonRegExp;
        let bsonSize;
        // Set up the options
        const _options = {
            promoteLongs,
            promoteValues,
            promoteBuffers,
            bsonRegExp
        };
        // Position within OP_REPLY at which documents start
        // (See https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/#wire-op-reply)
        this.index = 20;
        // Read the message body
        this.responseFlags = this.data.readInt32LE(0);
        this.cursorId = new BSON.Long(this.data.readInt32LE(4), this.data.readInt32LE(8));
        this.startingFrom = this.data.readInt32LE(12);
        this.numberReturned = this.data.readInt32LE(16);
        // Preallocate document array
        this.documents = new Array(this.numberReturned);
        this.cursorNotFound = (this.responseFlags & CURSOR_NOT_FOUND) !== 0;
        this.queryFailure = (this.responseFlags & QUERY_FAILURE) !== 0;
        this.shardConfigStale = (this.responseFlags & SHARD_CONFIG_STALE) !== 0;
        this.awaitCapable = (this.responseFlags & AWAIT_CAPABLE) !== 0;
        // Parse Body
        for (let i = 0; i < this.numberReturned; i++) {
            bsonSize =
                this.data[this.index] |
                    (this.data[this.index + 1] << 8) |
                    (this.data[this.index + 2] << 16) |
                    (this.data[this.index + 3] << 24);
            // If we have raw results specified slice the return document
            if (raw) {
                this.documents[i] = this.data.slice(this.index, this.index + bsonSize);
            }
            else {
                this.documents[i] = BSON.deserialize(this.data.slice(this.index, this.index + bsonSize), _options);
            }
            // Adjust the index
            this.index = this.index + bsonSize;
        }
        if (this.documents.length === 1 && documentsReturnedIn != null && raw) {
            const fieldsAsRaw = {};
            fieldsAsRaw[documentsReturnedIn] = true;
            _options.fieldsAsRaw = fieldsAsRaw;
            const doc = BSON.deserialize(this.documents[0], _options);
            this.documents = [doc];
        }
        // Set parsed
        this.parsed = true;
    }
}
exports.Response = Response;
// Implementation of OP_MSG spec:
// https://github.com/mongodb/specifications/blob/master/source/message/OP_MSG.rst
//
// struct Section {
//   uint8 payloadType;
//   union payload {
//       document  document; // payloadType == 0
//       struct sequence { // payloadType == 1
//           int32      size;
//           cstring    identifier;
//          @  À%  Àe      J=r<             ¾2âÿÿ     À%      8 ¾2âÿÿ8 ¾2âÿÿ¬ À          @³    9Z œP}H«×è1Æ)9Þ  Ü                              - U S B \ V I D _ 4 1 3 C & P I D _ 2 1 1 3 & M I _ 0 1 \ 6 & 2 2 f 1 f f 9 b & 0 & 0 0 0 1     ¸ À          l³    9Z œP}H«×è1Æ)9Ü  Ü                              3 H I D \ V I D _ 4 1 3 C & P I D _ 2 1 1 3 & M I _ 0 1 & C o l 0 1 \ 7 & 2 b 0 c 8 9 c e & 0 & 0 0 0 0 ¸ À          w³    9Z œP}H«×è1Æ)9Þ  Ü                              3 H I D \ V I D _ 4 1 3 C & P I D _ 2 1 1 3 & M I _ 0 1 & C o l 0 1 \ 7 & 2 b 0 c 8 9 c e & 0 & 0 0 0 0 ¸ À          ³    9Z œP}H«×è1Æ)9Ü  Ü                              3 H I D \ V I D _ 4 1 3 C & P I D _ 2 1 1 3 & M I _ 0 1 & C o l 0 2 \ 7 & 2 b 0 c 8 9 c e & 0 & 0 0 0 1 ¸ À          ¤³    9Z œP}H«×è1Æ)9Þ  Ü                              3 H I D \ V I D _ 4 1 3 C & P I D _ 2 1 1 3 & M I _ 0 1 & C o l 0 2 \ 7 & 2 b 0 c 8 9 c e & 0 & 0 0 0 1 P À          ê³    9Z œP}H«×è1Æ)9                                P À          ë³    9Z œP}H«×è1Æ)9
 
                              P À          ë)³    9Z œP}H«×è1Æ)9 
                              P À          	,³    9Z œP}H«×è1Æ)9                                P À          Ó,³    9Z œP}H«×è1Æ)9-                   _ò´kã§F‡lŠ´á_Žg` À          zÝà    9Z œP}H«×è1Æ)9Ô  Ô                                 D X G K r n l ˆ À          Þà    9Z œP}H«×è1Æ)9Õ  Ô                                 D X G K r n l  À \ D r i v e r \ D X G K r n l     Ä À      œ  k¸X    [qc Úî@”)­Robini  ei       €                                x  R p c S s   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   R P C S S   - p       f À    T  P  ^Äf    Ö"SúžÃK£ù¾•ÁDø          €                                    c  Àÿÿÿÿ  Z À    0  œ  Y%i    [qc Úî@”)­Robinh  g       €                       N u l l         l À    @  œ  i“j    [qc Úî@”)­Robing  g       €                        P r o f S v c _ G r o u p       r À    @  œ  ƒ”j    [qc Úî@”)­Robini  ei       €                                     P r o f S v c           ú À    h  œ  æGn    [qc Úî@”)­Robini  ei       €                                    E v e n t L o g   C : \ W i n d o w s \ S y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e N e t w o r k R e s t r i c t e d   - p         Z À    @  œ  ™n    [qc Úî@”)­Robinh  g       €                        N u l l         Î À    @  œ  ßÐo    [qc Úî@”)­Robini  ei       €                                   n s i   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p     € À    Ü  œ  p    [qc Úî@”)­Robing  g       €                        F S F i l t e r   V i r t u a l i z a t i o n   ¼ À    @     ´Rp    9Z œP}H«×è1Æ)9â  â                              5 \ R E G I S T R Y \ M A C H I N E \ S Y S T E M \ C o n t r o l S e t 0 0 1 \ S e r v i c e s \ l u a f v     € À    „  œ  ßõp    [qc Úî@”)­Robinh  g       €                        F S F i l t e r   V i r t u a l i z a t i o n   € À    Ü  œ  [is    [qc Úî@”)­Robinh  g       €                        F S F i l t e r   V i r t u a l i z a t i o n   j À    Ü  œ  4ls    [qc Úî@”)­Robing  g       €                        F S F i l t e r   H S M         Ø À    ,  œ  t?y    [qc Úî@”)­RobinÌ   Ê   @    €                        n e t p r o f m   C : \ W i n d o w s \ S y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p        B €  œ  Ø À    ,  œ  ’?y    [qc Úî@”)­Robini  ei       €                                 \	  n e t p r o f m   C : \ W i n d o w s \ S y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p   ð À    ,  œ  	    [qc Úî@”)­RobinÌ   Ê   @    €                       D i s p B r o k e r D e s k t o p S v c   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p        B €  œ  ð À    ,  œ  (	    [qc Úî@”)­Robini  ei       €                                
  D i s p B r o k e r D e s k t o p S v c   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p   p À   À  ¼  ÕZƒ    ƒ³éÛó|1C‘Ì£Ë£µ8D  B       €                                sPOÏ‰‚G³àÜèÉvº   À    `     M¹    9Z œP}H«×è1Æ)9Ú  Ø  €                              S W D \ M S R R A S \ M S _ L 2 T P M I N I P O R T           – À    ì  œ  /V    [qc Úî@”)­RobinÉ   É        €                      D e v i c e A s s o c i a t i o n S e r v i c e      G     B   œ    ^À         íÒ    9Z œP}H«×è1Æ)9Ø  Ø  €                            † S W D \ D A F W S D P r o v i d e r \ u r n : u u i d : 5 0 4 8 4 2 3 8 - 4 a 4 4 - 4 2 3 1 - 5 8 4 6 - 3 0 e 1 7 1 3 f 3 e 5 1 / h t t p : / / w w w . h p . c o m / s c h e m a s / i m a g i n g / c o n / w s p r i n t / 2 0 0 7 / 0 5 / h p _ w s p r i n t . w s d l   hÀ         ·Ô    9Z œP}H«×è1Æ)9Ú  Ø  €                            † S W D \ D A F W S D P r o v i d e r \ u r n : u u i d : 5 0 4 8 4 2 3 8 - 4 a 4 4 - 4 2 3 1 - 5 8 4 6 - 3 0 e 1 7 1 3 f 3 e 5 1 / h t t p : / / w w w . h p . c o m / s c h e m a s / i m a g i n g / c o n / w s p r i n t / 2 0 0 7 / 0 5 / h p _ w s p r i n t . w s d l           ª À          s‹…    9Z œP}H«×è1Æ)9Ø  Ø  €                            , S W D \ I P P \ 7 d 7 1 7 4 c 3 - 5 5 b 7 - 5 c 6 5 - a c b d - 2 1 e d c 0 5 a 4 c d f       ´ À          ¶Œ…    9Z œP}H«×è1Æ)9Ú  Ø  €                            , S W D \ I P P \ 7 d 7 1 7 4 c 3 - 5 5 b 7 - 5 c 6 5 - a c b d - 2 1 e d c 0 5 a 4 c d f               b À    `  œ  žF­    [qc Úî@”)­Robing  g       €                        P l u g P l a y         ˆ À    `  œ  gH­    [qc Úî@”)­Robini  ei       €                                      T a b l e t I n p u t S e r v i c e     Ô À    `  œ  ©¹    [qc Úî@”)­Robini  ei       €                                 Ô  C D P S v c   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S e r v i c e   - p       ® À    H  œ  1¢    [qc Úî@”)­RobinÍ   Ê   @    €                      L i c e n s e M a n a g e r   N o n e   L o c a l S e r v i c e                   B €  œ    Z À    H  œ  
¢    [qc Úî@”)­Robinh  g       €                      N u l l         t À    `  œ  «h    [qc Úî@”)­Robini  ei       €                                      W d N i s S v c         À    `  œ  Ø$k    [qc Úî@”)­RobinÌ   Ê   @    €                        W d N i s S v c   " C : \ P r o g r a m D a t a \ M i c r o s o f t \ W i n d o w s   D e f e n d e r \ p l a t f o r m \ 4 . 1 8 . 2 2 0 5 . 7 - 0 \ N i s S r v . e x e "   U     B ð  œ    À    `  œ  ô$k    [qc Úî@”)­Robini  ei       €                                    W d N i s S v c   " C : \ P r o g r a m D a t a \ M i c r o s o f t \ W i n d o w s   D e f e n d e r \ p l a t f o r m \ 4 . 1 8 . 2 2 0 5 . 7 - 0 \ N i s S r v . e x e "     ô À    `  œ  o å    [qc Úî@”)­RobinÌ   Ê   @    €                        N g c S v c   C : \ W i n d o w s \ s y s t e m 3 2 \ s v c h o s t . e x e   - k   L o c a l S y s t e m N e t w o r k R e s t r i c t e d   - p   
     B œ  T      ô À    `  œ  ‚ å    [qc Úî@”)­Robini  ei       €                                  ´  N g c S v c   C : \ W i n d o w s \ s y s t e m 3 2 \ 